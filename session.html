<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'">
  <title>Sesja – HYPERCORTEX</title>
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden;color:#fff}
    #visual-bg{position:fixed;inset:0;background:#000;pointer-events:none;transition:opacity .2s}
    #gate,#controls{position:fixed;z-index:9;width:100%;display:flex;align-items:center;justify-content:center}
    #gate{inset:0;cursor:pointer;font:700 24px monospace;background:#000}
    #controls{top:20px;justify-content:flex-end;padding-right:20px}
    button{background:#111;border:1px solid #555;color:#fff;padding:10px 20px;font-size:1em;cursor:pointer}
    button:hover{background:#222}
  </style>
</head>
<body>
<div id="visual-bg"></div>
<div id="gate">▶ START SESSION</div>
<div id="controls" style="display:none">
  <button onclick="endSession()">⏹️ ZAKOŃCZ</button>
</div>

<script>
/* ---------- BASIC SETUP ---------- */
const src = new URLSearchParams(location.search).get('session');
if(!src) document.getElementById('gate').textContent='❗ Brak parametru ?session=';

let phases=[], p=0, ctx,oscL,oscR,gL,gR,anim,vis={};

document.getElementById('gate').onclick = async () =>{
  try{ phases = (await fetch(src)).ok ? await (await fetch(src)).json().then(d=>d.phases) : []; }
  catch(e){ console.error(e); return alert('Nie mogę wczytać pliku '+src); }
  initAudio(); this.remove(); document.getElementById('controls').style.display='flex'; play(0);
};

/* ---------- AUDIO ---------- */
function initAudio(){
  ctx=new (AudioContext||webkitAudioContext)();
  oscL=ctx.createOscillator(); oscR=ctx.createOscillator();
  gL=ctx.createGain(); gR=ctx.createGain();
  const m=ctx.createChannelMerger(2);
  oscL.connect(gL).connect(m,0,0); oscR.connect(gR).connect(m,0,1); m.connect(ctx.destination);
  oscL.start(); oscR.start();
}
function setAudio(a,dur){
  const t=ctx.currentTime;
  const [l0,l1]=[a.carrier_left_start??a.carrier_left,  a.carrier_left_end  ??a.carrier_left];
  const [r0,r1]=[a.carrier_right_start??a.carrier_right??l0, a.carrier_right_end??a.carrier_right??l0];
  oscL.frequency.setValueAtTime(l0,t); oscR.frequency.setValueAtTime(r0,t);
  oscL.frequency.linearRampToValueAtTime(l1,t+dur); oscR.frequency.linearRampToValueAtTime(r1,t+dur);
  const v0=a.volume_start??a.volume??.4, v1=a.volume_end??a.volume??v0;
  [gL.gain,gR.gain].forEach(g=>{g.setValueAtTime(v0,t);g.linearRampToValueAtTime(v1,t+dur);});
  oscL.type=oscR.type=a.waveform??'sine';
}

/* ---------- VISUAL ---------- */
function setVisual(v,dur){
  vis={f0:v.frequency_start??v.frequency??10,f1:v.frequency_end??v.frequency??10,
       b0:v.brightness_start??v.brightness??.4,b1:v.brightness_end??v.brightness??.4,
       c0:v.color_start??v.color??'#000',c1:v.color_end??v.color??'#000',
       mod:v.modulation??'sine',dur,start:performance.now()};
  cancelAnimationFrame(anim); anim=requestAnimationFrame(loop);
}
function loop(ts){
  const t=(ts-vis.start)/1000, prog=Math.min(t/vis.dur,1);
  const f=vis.f0+(vis.f1-vis.f0)*prog;
  const cyc=vis.mod==='pulse'?(Math.sin(2*Math.PI*f*t)>0?1:0):.5+.5*Math.sin(2*Math.PI*f*t);
  const br=cyc*(vis.b0+(vis.b1-vis.b0)*prog);
  const bg=document.getElementById('visual-bg');
  bg.style.background=prog<1?vis.c0:vis.c1; bg.style.opacity=br.toFixed(2);
  anim=requestAnimationFrame(loop);
}

/* ---------- PHASE ENGINE ---------- */
function play(i){
  p=i; const ph=phases[i], dur=ph.end-ph.start;
  setAudio(ph.audio,dur); setVisual(ph.visual,dur);
  if(i<phases.length-1) setTimeout(()=>play(i+1),dur*1000); else setTimeout(endSession,dur*1000);
}

/* ---------- STOP ---------- */
function endSession(){
  try{oscL.stop();oscR.stop();ctx.close();}catch{} cancelAnimationFrame(anim); window.close();
}
</script>
</body>
</html>
