<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline';">
  <title>Sesja – HYPERCORTEX</title>
  <style>
    html,body{margin:0;padding:0;background:#000;height:100%;overflow:hidden;}
    #visual-bg{position:fixed;inset:0;background:#000;pointer-events:none;transition:opacity .2s;}
    #gate,#controls{position:fixed;z-index:9;display:flex;gap:20px}
    #gate{inset:0;align-items:center;justify-content:center;background:#000;cursor:pointer;color:#0f0;font:700 24px/1 monospace}
    #controls{top:20px;right:20px}
    button{background:#111;color:#fff;border:1px solid #555;padding:10px 20px;font-size:1em;cursor:pointer;}
    button:hover{background:#222}
  </style>
</head>
<body>
<div id="visual-bg"></div>
<div id="gate">▶ START SESSION</div>
<div id="controls" style="display:none">
  <button onclick="endSession()">⏹️ ZAKOŃCZ</button>
</div>

<script>
/* ---------- CONFIG ---------- */
const params     = new URLSearchParams(location.search);
const sessionURL = params.get('session');             // ?session=foo.json

/* ---------- STATE ---------- */
let phases=[], iPhase=0, audioCtx, oscL,oscR,gainL,gainR;
let vis={}, visStart=0, animId;

/* ---------- ENTRY ---------- */
document.getElementById('gate').addEventListener('click', async()=>{
  phases = (await (await fetch(sessionURL)).json()).phases;
  document.getElementById('gate').remove();
  document.getElementById('controls').style.display='flex';
  bootAudio();
  playPhase(0);
});

/* ---------- AUDIO ---------- */
function bootAudio(){
  audioCtx = new (AudioContext||webkitAudioContext)();
  oscL  = audioCtx.createOscillator();
  oscR  = audioCtx.createOscillator();
  gainL = audioCtx.createGain();
  gainR = audioCtx.createGain();
  const merger = audioCtx.createChannelMerger(2);
  oscL.connect(gainL).connect(merger,0,0);
  oscR.connect(gainR).connect(merger,0,1);
  merger.connect(audioCtx.destination);
  oscL.start(); oscR.start();
}

function applyAudio(a,dur){
  const now=audioCtx.currentTime;
  // carrier freq
  if(a.carrier_left_start||a.carrier_left_end){
    oscL.frequency.setValueAtTime(a.carrier_left_start??a.carrier_left,now);
    oscL.frequency.linearRampToValueAtTime(a.carrier_left_end??oscL.frequency.value,now+dur);
  } else oscL.frequency.setValueAtTime(a.carrier_left,now);
  if(a.carrier_right_start||a.carrier_right_end){
    oscR.frequency.setValueAtTime(a.carrier_right_start??a.carrier_right??a.carrier_left,now);
    oscR.frequency.linearRampToValueAtTime(a.carrier_right_end??oscR.frequency.value,now+dur);
  } else oscR.frequency.setValueAtTime(a.carrier_right??a.carrier_left,now);
  // volume
  const v0=a.volume_start??a.volume??.4, v1=a.volume_end??a.volume??v0;
  gainL.gain.setValueAtTime(v0,now);
  gainR.gain.setValueAtTime(v0,now);
  gainL.gain.linearRampToValueAtTime(v1,now+dur);
  gainR.gain.linearRampToValueAtTime(v1,now+dur);
  // waveform
  oscL.type = oscR.type = a.waveform??'sine';
}

/* ---------- VISUAL ---------- */
function applyVisual(v,dur){
  vis={
    f0:v.frequency_start??v.frequency??10,
    f1:v.frequency_end  ??v.frequency??10,
    b0:v.brightness_start??v.brightness??.4,
    b1:v.brightness_end  ??v.brightness??.4,
    c0:v.color_start??v.color??'#000',
    c1:v.color_end  ??v.color??'#000',
    mod:v.modulation??'sine',
    dur
  };
  visStart = performance.now();
  cancelAnimationFrame(animId);
  animId = requestAnimationFrame(loopVis);
}

function lerp(a,b,t){return a+(b-a)*t}
function loopVis(ts){
  const t = (ts-visStart)/1000, p = Math.min(t/vis.dur,1);
  const freq = lerp(vis.f0,vis.f1,p);
  const brBase = vis.mod==='pulse' ? (Math.sin(2*Math.PI*freq*t)>0?1:0)
                                   : .5+.5*Math.sin(2*Math.PI*freq*t);
  const br = brBase*lerp(vis.b0,vis.b1,p);
  const bg = document.getElementById('visual-bg');
  // simple HSL fade for color
  bg.style.background = p<1?vis.c0:vis.c1;
  bg.style.opacity    = br.toFixed(2);
  animId = requestAnimationFrame(loopVis);
}

/* ---------- PHASE ENGINE ---------- */
function playPhase(n){
  iPhase = n;
  const p = phases[n];
  const dur = (p.end - p.start);
  applyAudio (p.audio,  dur);
  applyVisual(p.visual,dur);
  if(n<phases.length-1)
    setTimeout(()=>playPhase(n+1), dur*1000);
  else
    setTimeout(endSession, dur*1000);
}

/* ---------- FIN ---------- */
function endSession(){
  try{oscL.stop();oscR.stop();audioCtx.close();}catch{}
  cancelAnimationFrame(animId);
  window.close();
}
</script>
</body>
</html>
