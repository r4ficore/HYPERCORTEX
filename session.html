<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline';">
  <title>Sesja – HYPERCORTEX</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      overflow: hidden;
      height: 100%;
    }
    #visual-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: black;
      z-index: -1;
      pointer-events: none;
      transition: background 0.2s, opacity 0.2s;
    }
    #controls {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2;
    }
    button {
      background: #111;
      color: #fff;
      border: 1px solid #555;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 1em;
    }
    button:hover {
      background: #222;
    }
  </style>
</head>
<body>
<div id="visual-bg"></div>
<div id="controls">
  <button onclick="endSession()">⏹️ ZAKOŃCZ</button>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const sessionFile = urlParams.get('session');
let audioCtx;
let oscL, oscR, gainL, gainR, merger;
let visualData = {};
let startTime;

function setupAudio(a) {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  oscL = audioCtx.createOscillator();
  oscR = audioCtx.createOscillator();
  gainL = audioCtx.createGain();
  gainR = audioCtx.createGain();
  merger = audioCtx.createChannelMerger(2);

  oscL.frequency.value = a.carrier_left;
  oscR.frequency.value = a.carrier_right || a.carrier_right_start || a.carrier_left;
  oscL.type = a.waveform || "sine";
  oscR.type = a.waveform || "sine";
  gainL.gain.value = a.volume_start || a.volume || 0.4;
  gainR.gain.value = a.volume_start || a.volume || 0.4;

  oscL.connect(gainL).connect(merger, 0, 0);
  oscR.connect(gainR).connect(merger, 0, 1);
  merger.connect(audioCtx.destination);

  oscL.start();
  oscR.start();
}

function setupVisual(v) {
  visualData = {
    frequency: v.frequency || 10,
    brightness: v.brightness_start || v.brightness || 0.4,
    color: v.color || "#222",
    modulation: v.modulation || "sine"
  };
  startTime = performance.now();
  requestAnimationFrame(animateVisual);
}

function animateVisual(timestamp) {
  const t = (timestamp - startTime) / 1000;
  const base = 0.5 + 0.5 * Math.sin(2 * Math.PI * visualData.frequency * t);
  const brightness = visualData.modulation === "sine" ? base : 1;
  const color = visualData.color;

  const visual = document.getElementById("visual-bg");
  visual.style.background = color;
  visual.style.opacity = (brightness * visualData.brightness).toFixed(2);
  requestAnimationFrame(animateVisual);
}

function endSession() {
  if (oscL) oscL.stop();
  if (oscR) oscR.stop();
  if (audioCtx) audioCtx.close();
  window.close();
}

fetch(sessionFile)
  .then(res => res.json())
  .then(data => {
    setupAudio(data.phases[0].audio);
    setupVisual(data.phases[0].visual);
  });
</script>
</body>
</html>
